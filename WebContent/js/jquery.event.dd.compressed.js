(function(e){e.fn.drag=function(t,n,r){var i=typeof t=="string"?t:"",s=e.isFunction(t)?t:e.isFunction(n)?n:null;if(i.indexOf("drag")!==0)i="drag"+i;r=(t==s?n:r)||{};return s?this.bind(i,r,s):this.trigger(i)};var t=e.event,n=t.special,r=n.drag={defaults:{which:1,distance:0,not:":input",handle:null,relative:false,drop:true,click:false},datakey:"dragdata",noBubble:true,add:function(t){var n=e.data(this,r.datakey),i=t.data||{};n.related+=1;e.each(r.defaults,function(e,t){if(i[e]!==undefined)n[e]=i[e]})},remove:function(){e.data(this,r.datakey).related-=1},setup:function(){if(e.data(this,r.datakey))return;var n=e.extend({related:0},r.defaults);e.data(this,r.datakey,n);t.add(this,"touchstart mousedown",r.init,n);if(this.attachEvent)this.attachEvent("ondragstart",r.dontstart)},teardown:function(){var n=e.data(this,r.datakey)||{};if(n.related)return;e.removeData(this,r.datakey);t.remove(this,"touchstart mousedown",r.init);r.textselect(true);if(this.detachEvent)this.detachEvent("ondragstart",r.dontstart)},init:function(i){if(r.touched)return;var s=i.data,o;if(i.which!=0&&s.which>0&&i.which!=s.which)return;if(e(i.target).is(s.not))return;if(s.handle&&!e(i.target).closest(s.handle,i.currentTarget).length)return;r.touched=i.type=="touchstart"?this:null;s.propagates=1;s.mousedown=this;s.interactions=[r.interaction(this,s)];s.target=i.target;s.pageX=i.pageX;s.pageY=i.pageY;s.dragging=null;o=r.hijack(i,"draginit",s);if(!s.propagates)return;o=r.flatten(o);if(o&&o.length){s.interactions=[];e.each(o,function(){s.interactions.push(r.interaction(this,s))})}s.propagates=s.interactions.length;if(s.drop!==false&&n.drop)n.drop.handler(i,s);r.textselect(false);if(r.touched)t.add(r.touched,"touchmove touchend",r.handler,s);else t.add(document,"mousemove mouseup",r.handler,s);if(!r.touched||s.live)return false},interaction:function(t,n){var i=e(t)[n.relative?"position":"offset"]()||{top:0,left:0};return{drag:t,callback:new r.callback,droppable:[],offset:i}},handler:function(i){var s=i.data;switch(i.type){case!s.dragging&&"touchmove":i.preventDefault();case!s.dragging&&"mousemove":if(Math.pow(i.pageX-s.pageX,2)+Math.pow(i.pageY-s.pageY,2)<Math.pow(s.distance,2))break;i.target=s.target;r.hijack(i,"dragstart",s);if(s.propagates)s.dragging=true;case"touchmove":i.preventDefault();case"mousemove":if(s.dragging){r.hijack(i,"drag",s);if(s.propagates){if(s.drop!==false&&n.drop)n.drop.handler(i,s);break}i.type="mouseup"};case"touchend":case"mouseup":default:if(r.touched)t.remove(r.touched,"touchmove touchend",r.handler);else t.remove(document,"mousemove mouseup",r.handler);if(s.dragging){if(s.drop!==false&&n.drop)n.drop.handler(i,s);r.hijack(i,"dragend",s)}r.textselect(true);if(s.click===false&&s.dragging)e.data(s.mousedown,"suppress.click",(new Date).getTime()+5);s.dragging=r.touched=false;break}},hijack:function(n,i,s,o,u){if(!s)return;var a={event:n.originalEvent,type:n.type},f=i.indexOf("drop")?"drag":"drop",l,c=o||0,h,p,d,v=!isNaN(o)?o:s.interactions.length;n.type=i;n.originalEvent=null;s.results=[];do if(h=s.interactions[c]){if(i!=="dragend"&&h.cancelled)continue;d=r.properties(n,s,h);h.results=[];e(u||h[f]||s.droppable).each(function(o,u){d.target=u;n.isPropagationStopped=function(){return false};l=u?t.dispatch.call(u,n,d):null;if(l===false){if(f=="drag"){h.cancelled=true;s.propagates-=1}if(i=="drop"){h[f][o]=null}}else if(i=="dropinit")h.droppable.push(r.element(l)||u);if(i=="dragstart")h.proxy=e(r.element(l)||h.drag)[0];h.results.push(l);delete n.result;if(i!=="dropinit")return l});s.results[c]=r.flatten(h.results);if(i=="dropinit")h.droppable=r.flatten(h.droppable);if(i=="dragstart"&&!h.cancelled)d.update()}while(++c<v);n.type=a.type;n.originalEvent=a.event;return r.flatten(s.results)},properties:function(e,t,n){var i=n.callback;i.drag=n.drag;i.proxy=n.proxy||n.drag;i.startX=t.pageX;i.startY=t.pageY;i.deltaX=e.pageX-t.pageX;i.deltaY=e.pageY-t.pageY;i.originalX=n.offset.left;i.originalY=n.offset.top;i.offsetX=i.originalX+i.deltaX;i.offsetY=i.originalY+i.deltaY;i.drop=r.flatten((n.drop||[]).slice());i.available=r.flatten((n.droppable||[]).slice());return i},element:function(e){if(e&&(e.jquery||e.nodeType==1))return e},flatten:function(t){return e.map(t,function(t){return t&&t.jquery?e.makeArray(t):t&&t.length?r.flatten(t):t})},textselect:function(t){e(document)[t?"unbind":"bind"]("selectstart",r.dontstart).css("MozUserSelect",t?"":"none");document.unselectable=t?"off":"on"},dontstart:function(){return false},callback:function(){}};r.callback.prototype={update:function(){if(n.drop&&this.available.length)e.each(this.available,function(e){n.drop.locate(this,e)})}};var i=t.dispatch;t.dispatch=function(t){if(e.data(this,"suppress."+t.type)-(new Date).getTime()>0){e.removeData(this,"suppress."+t.type);return}return i.apply(this,arguments)};var s=t.fixHooks.touchstart=t.fixHooks.touchmove=t.fixHooks.touchend=t.fixHooks.touchcancel={props:"clientX clientY pageX pageY screenX screenY".split(" "),filter:function(t,n){if(n){var r=n.touches&&n.touches[0]||n.changedTouches&&n.changedTouches[0]||null;if(r)e.each(s.props,function(e,n){t[n]=r[n]})}return t}};n.draginit=n.dragstart=n.dragend=r})(jQuery);(function(e){var t=e.event,n=t.special.drag,r=n.add,i=n.teardown;n.noBubble=false;n.livekey="livedrag";n.add=function(i){r.apply(this,arguments);var s=e.data(this,n.datakey);if(!s.live&&i.selector){s.live=true;t.add(this,"draginit."+n.livekey,n.delegate)}};n.teardown=function(){i.apply(this,arguments);var r=e.data(this,n.datakey)||{};if(r.live){t.remove(this,"draginit."+n.livekey,n.delegate);r.live=false}};n.delegate=function(r){var i=[],s,o=e.data(this,"events")||{};e.each(o||[],function(o,u){if(o.indexOf("drag")!==0)return;e.each(u||[],function(o,u){s=e(r.target).closest(u.selector,r.currentTarget)[0];if(!s)return;t.add(s,u.origType+"."+n.livekey,u.origHandler||u.handler,u.data);if(e.inArray(s,i)<0)i.push(s)})});if(!i.length)return false;return e(i).bind("dragend."+n.livekey,function(){t.remove(this,"."+n.livekey)})}})(jQuery);(function(e){e.fn.drop=function(t,n,r){var i=typeof t=="string"?t:"",s=e.isFunction(t)?t:e.isFunction(n)?n:null;if(i.indexOf("drop")!==0)i="drop"+i;r=(t==s?n:r)||{};return s?this.bind(i,r,s):this.trigger(i)};e.drop=function(t){t=t||{};r.multi=t.multi===true?Infinity:t.multi===false?1:!isNaN(t.multi)?t.multi:r.multi;r.delay=t.delay||r.delay;r.tolerance=e.isFunction(t.tolerance)?t.tolerance:t.tolerance===null?null:r.tolerance;r.mode=t.mode||r.mode||"intersect"};var t=e.event,n=t.special,r=e.event.special.drop={multi:1,delay:20,mode:"overlap",targets:[],datakey:"dropdata",noBubble:true,add:function(t){var n=e.data(this,r.datakey);n.related+=1},remove:function(){e.data(this,r.datakey).related-=1},setup:function(){if(e.data(this,r.datakey))return;var t={related:0,active:[],anyactive:0,winner:0,location:{}};e.data(this,r.datakey,t);r.targets.push(this)},teardown:function(){var t=e.data(this,r.datakey)||{};if(t.related)return;e.removeData(this,r.datakey);var n=this;r.targets=e.grep(r.targets,function(e){return e!==n})},handler:function(t,i){var s,o;if(!i)return;switch(t.type){case"mousedown":case"touchstart":i.interactions[0].callback["mouseState"]="down";o=e(r.targets);if(typeof i.drop=="string")o=o.filter(i.drop);o.each(function(){var t=e.data(this,r.datakey);t.active=[];t.anyactive=0;t.winner=0});i.droppable=o;n.drag.hijack(t,"dropinit",i);break;case"mousemove":case"touchmove":r.event=t;if(!r.timer)r.tolerate(i);break;case"mouseup":case"touchend":i.interactions[0].callback["mouseState"]="up";r.timer=clearTimeout(r.timer);if(i.propagates){n.drag.hijack(t,"drop",i);n.drag.hijack(t,"dropend",i)}break}},locate:function(t,n){var i=e.data(t,r.datakey),s=e(t),o=s.offset()||{},u=s.outerHeight(),a=s.outerWidth(),f={elem:t,width:a,height:u,top:o.top,left:o.left,right:o.left+a,bottom:o.top+u};if(i){i.location=f;i.index=n;i.elem=t}return f},contains:function(e,t){return(t[0]||t.left)>=e.left&&(t[0]||t.right)<=e.right&&(t[1]||t.top)>=e.top&&(t[1]||t.bottom)<=e.bottom},modes:{intersect:function(e,t,n){return this.contains(n,[e.pageX,e.pageY])?1e9:this.modes.overlap.apply(this,arguments)},overlap:function(e,t,n){return Math.max(0,Math.min(n.bottom,t.bottom)-Math.max(n.top,t.top))*Math.max(0,Math.min(n.right,t.right)-Math.max(n.left,t.left))},fit:function(e,t,n){return this.contains(n,t)?1:0},middle:function(e,t,n){return this.contains(n,[t.left+t.width*.5,t.top+t.height*.5])?1:0}},sort:function(e,t){return t.winner-e.winner||e.index-t.index},tolerate:function(t){var i,s,o,u,a,f,l,c=0,h,p=t.interactions.length,d=[r.event.pageX,r.event.pageY],v=r.tolerance||r.modes[r.mode];do if(h=t.interactions[c]){if(!h)return;h.drop=[];a=[];f=h.droppable.length;if(v)o=r.locate(h.proxy);i=0;do if(l=h.droppable[i]){u=e.data(l,r.datakey);s=u.location;if(!s)continue;u.winner=v?v.call(r,r.event,o,s):r.contains(s,d)?1:0;a.push(u)}while(++i<f);a.sort(r.sort);i=0;do if(u=a[i]){if(u.winner&&h.drop.length<r.multi){if(!u.active[c]&&!u.anyactive){if(n.drag.hijack(r.event,"dropstart",t,c,u.elem)[0]!==false){u.active[c]=1;u.anyactive+=1}else u.winner=0}if(u.winner)h.drop.push(u.elem)}else if(u.active[c]&&u.anyactive==1){n.drag.hijack(r.event,"dropend",t,c,u.elem);u.active[c]=0;u.anyactive-=1}}while(++i<f)}while(++c<p);if(r.last&&d[0]==r.last.pageX&&d[1]==r.last.pageY)delete r.timer;else r.timer=setTimeout(function(){r.tolerate(t)},r.delay);r.last=r.event}};n.dropinit=n.dropstart=n.dropend=r})(jQuery);(function(e){var t=e.event,n=t.special.drop,r=n.add,i=n.teardown;n.noBubble=false;n.livekey="livedrop";n.add=function(i){r.apply(this,arguments);var s=e.data(this,n.datakey);if(!s.live&&i.selector){s.live=true;t.add(this,"dropinit."+n.livekey,n.delegate)}};n.teardown=function(){i.apply(this,arguments);var r=e.data(this,n.datakey)||{};if(r.live){t.remove(this,"dropinit",n.delegate);r.live=false}};n.delegate=function(r,i){var s=[],o,u=e.data(this,"events")||{};e.each(u||[],function(i,u){if(i.indexOf("drop")!==0)return;e.each(u,function(i,u){o=e(r.currentTarget).find(u.selector);if(!o.length)return;o.each(function(){t.add(this,u.origType+"."+n.livekey,u.origHandler||u.handler,u.data);if(e.inArray(this,s)<0)s.push(this)})})});if(i)t.add(i.drag,"dragend."+n.livekey,function(){e.each(s.concat(this),function(){t.remove(this,"."+n.livekey)})});return s.length?e(s):false}})(jQuery)